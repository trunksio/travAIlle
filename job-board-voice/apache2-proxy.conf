# Apache2 Reverse Proxy Configuration for Internal Career Mobility Platform
# 
# This configuration sets up reverse proxy endpoints for the job portal application
# running in Docker containers on ports 5010-5012
#
# Installation:
# 1. Enable required Apache modules:
#    sudo a2enmod proxy proxy_http proxy_wstunnel headers rewrite
# 2. Copy this file to Apache sites-available:
#    sudo cp apache2-proxy.conf /etc/apache2/sites-available/job-portal.conf
# 3. Enable the site:
#    sudo a2ensite job-portal
# 4. Reload Apache:
#    sudo systemctl reload apache2

<VirtualHost *:80>
    # Server configuration
    ServerName your-domain.com
    ServerAdmin webmaster@your-domain.com
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/job-portal-error.log
    CustomLog ${APACHE_LOG_DIR}/job-portal-access.log combined
    
    # Enable proxy modules
    ProxyRequests Off
    ProxyPreserveHost On
    
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    
    # ========================================
    # Frontend Portal (Port 5011)
    # ========================================
    
    # Main portal endpoint
    <Location /job-portal>
        ProxyPass http://localhost:5011
        ProxyPassReverse http://localhost:5011
    </Location>
    
    # Portal static assets
    <LocationMatch "^/job-portal/(css|js|images|fonts)/">
        ProxyPass http://localhost:5011
        ProxyPassReverse http://localhost:5011
    </LocationMatch>
    
    # ========================================
    # Backend API (Port 5010)
    # ========================================
    
    # API endpoints
    <Location /job-portal/api>
        ProxyPass http://localhost:5010/api
        ProxyPassReverse http://localhost:5010/api
    </Location>
    
    # WebSocket support for real-time updates
    <Location /job-portal/ws>
        ProxyPass ws://localhost:5010/ws
        ProxyPassReverse ws://localhost:5010/ws
        
        # WebSocket specific headers
        Header always set Upgrade $http_upgrade
        Header always set Connection "upgrade"
    </Location>
    
    # ========================================
    # MCP Server (Port 5012)
    # ========================================
    
    # MCP Server SSE endpoint
    <Location /job-portal/mcp>
        ProxyPass http://localhost:5012
        ProxyPassReverse http://localhost:5012
        
        # SSE specific settings
        Header always set Cache-Control "no-cache"
        Header always set X-Accel-Buffering "no"
    </Location>
    
    # ========================================
    # URL Rewriting for Clean URLs
    # ========================================
    
    # Rewrite rules to handle clean URLs
    RewriteEngine On
    
    # Redirect root job-portal to index
    RewriteRule ^/job-portal/?$ /job-portal/index.html [L,PT]
    
    # Handle apply page
    RewriteRule ^/job-portal/apply/?$ /job-portal/apply.html [L,PT]
    
    # ========================================
    # Additional Configuration
    # ========================================
    
    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>
    
    # Cache control for static assets
    <LocationMatch "^/job-portal/.*\.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$">
        Header set Cache-Control "max-age=86400, public"
    </LocationMatch>
    
</VirtualHost>

# ========================================
# HTTPS Configuration (Optional)
# ========================================
# Uncomment and configure for SSL/TLS support

# <VirtualHost *:443>
#     ServerName your-domain.com
#     ServerAdmin webmaster@your-domain.com
#     
#     # SSL Configuration
#     SSLEngine on
#     SSLCertificateFile /path/to/certificate.crt
#     SSLCertificateKeyFile /path/to/private.key
#     SSLCertificateChainFile /path/to/chain.crt
#     
#     # Modern SSL configuration
#     SSLProtocol -all +TLSv1.2 +TLSv1.3
#     SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
#     SSLHonorCipherOrder off
#     SSLSessionTickets off
#     
#     # HSTS (optional)
#     Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
#     
#     # Include all the proxy configuration from above
#     # ... (copy all Location blocks from the HTTP section)
#     
# </VirtualHost>

# ========================================
# Alternative: Subdomain Configuration
# ========================================
# Use this instead if you prefer a subdomain approach

# <VirtualHost *:80>
#     ServerName job-portal.your-domain.com
#     
#     # Proxy everything to the frontend
#     ProxyPass / http://localhost:5011/
#     ProxyPassReverse / http://localhost:5011/
#     
#     # API proxy
#     ProxyPass /api http://localhost:5010/api
#     ProxyPassReverse /api http://localhost:5010/api
#     
#     # WebSocket proxy
#     ProxyPass /ws ws://localhost:5010/ws
#     ProxyPassReverse /ws ws://localhost:5010/ws
#     
#     # MCP proxy
#     ProxyPass /mcp http://localhost:5012/
#     ProxyPassReverse /mcp http://localhost:5012/
# </VirtualHost>